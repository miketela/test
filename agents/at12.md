# Agente AT12 (Flujo Unificado)

## Propósito
- Liderar `AT12` extremo a extremo: descubrimiento, exploración, transformación y consolidación.

## Entradas y Estructura
- Subtipos esperados (uno por mes): `BASE_AT12`, `TDC_AT12`, `VALORES_AT12`, `SOBREGIRO_AT12`, `AFECTACIONES_AT12`, `GARANTIA_AUTOS_AT12`, `POLIZA_HIPOTECAS_AT12`, `VALOR_MINIMO_AVALUO_AT12`, `AT02_CUENTAS`.
- Directorios: `source/` (entrada), `data/raw/` (espejo versionado), `data/processed/transforms/AT12/` (incidencias, procesados, consolidated), `metrics/`, `reports/`.

## Reglas Clave
- Período por defecto: mes previo; coherencia por nombre `[SUBTYPE]_[YYYYMMDD].CSV`.
- Duplicados: elegir fecha más reciente; emitir `warning`.
- AT02_CUENTAS: mapeo de headers por reemplazo directo (posición).
- Resto: normalización (acentos→ASCII, mayúsculas, underscores, limpiar `(1)`).

## Transformación (resumen por etapas)
- Etapa 1: limpieza y correcciones estructurales sobre `BASE_AT12`.
  - 1.1 `EEOR TABULAR`: trim/colapso de espacios en campos texto.
  - 1.2 `Error 0301` (Id_Documento para hipotecas 0301): reglas posicionales; trunca/avisa según caso.
  - 1.3 `COMA_EN_FINCA_EMPRESA`: elimina comas de `Id_Documento`.
  - 1.4 `FECHA_CANCELACION_ERRADA`: corrige `Fecha_Vencimiento` → `21001231` si año fuera de rango o formato inválido.
  - 1.5 `FECHA_AVALUO_ERRADA`: si `Fecha_Ultima_Actualizacion` > fin de mes anterior/<1985/ inválida → JOIN `AT03_CREDITOS` (`Numero_Prestamo` ↔ `num_cta`) y setea `fec_ini_prestamo`.
  - 1.6 `INMUEBLES_SIN_TIPO_POLIZA` (alineado especificación):
    - `Tipo_Garantia='0208'` y `Tipo_Poliza` vacío → `Tipo_Poliza='01'`.
    - `Tipo_Garantia='0207'` y `Tipo_Poliza` vacío → JOIN `POLIZA_HIPOTECAS_AT12` (`Numero_Prestamo` ↔ `numcred`) y si `seguro_incendio` ∈ {'01','02'} entonces asignar.
  - 1.7 `INMUEBLES_SIN_FINCA`: `Tipo_Garantia` ∈ {'0207','0208','0209'} y `Id_Documento` vacío o en {"0/0","1/0","1/1","1","9999/1","0/1","0"} → `Id_Documento='99999/99999'`.
  - 1.8 `AUTO_COMERCIAL_ORG_CODE`: `Tipo_Garantia='0106'` y `Nombre_Organismo` vacío → `Nombre_Organismo='700'`.
  - 1.9 `AUTO_NUM_POLIZA_FROM_GARANTIA_AUTOS`: `Tipo_Garantia='0101'` y `Id_Documento` vacío → JOIN `GARANTIA_AUTOS_AT12` (`Numero_Prestamo` ↔ `numcred`) y setea `Id_Documento = num_poliza`.
  - 1.10 `INMUEBLE_SIN_AVALUADORA_ORG_CODE`: `Tipo_Garantia` ∈ {'0207','0208','0209'} y `Nombre_Organismo` vacío → `Nombre_Organismo='774'`.
- Etapa 2: construcción `TDC_AT12`, `SOBREGIRO_AT12`, `VALORES_AT12` a partir de `BASE_AT12` con reglas de campo.
- Etapa 3: reportes operativos (`FUERA_CIERRE_AT12`).
- Etapa 4: validación `VALOR_MINIMO_AVALUO_AT12` con `AT03` (join por `num_cta`).
- Etapa 5: consolidación a TXT (separadores por subtipo; sin header; directorio `consolidated/`).

## Artefactos
- `metrics/exploration_metrics_*.json`, `reports/exploration_*.pdf` y `transformation_*.pdf`.
- Incidencias por etapa en `transforms/AT12/incidencias/`.
  - Formato por regla: `<REGLA>_<SUBTIPO>_<YYYYMMDD>.csv`, p.ej. `FECHA_AVALUO_ERRADA_BASE_AT12_20240131.csv`.
- Salidas finales en `transforms/AT12/consolidated/*.txt`.

## Comandos
- Explorar: `python main.py explore --atoms AT12 --year 2025 --month 08`.
- Transformar: `python main.py transform --atoms AT12 --year 2025 --month 08`.
- Reporte: `python main.py report --metrics-file metrics/<json>`.

## Checklist de PRs
- Precondiciones de transformación satisfechas (subtipos presentes, headers válidos).
- Incidencias y artefactos generados con `run_id`.
- Reglas alineadas con `context_files/transform_context.md`.
